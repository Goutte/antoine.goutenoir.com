version: "3.4"

services:
  php:
    # Container name is used in nginx config
    container_name: antoine.goutenoir.com_php
    build:
      context: .
      target: app_php
      args:
        SYMFONY_VERSION: ${SYMFONY_VERSION:-}
        STABILITY: ${STABILITY:-stable}
    restart: unless-stopped
    volumes:
      # We do not need that volume anymore, since we're using TCP not socket
      - php_socket:/var/run/php
    healthcheck:
      interval: 30s
      timeout: 3s
      retries: 2
      start_period: 30s
    environment:
      # Run "composer require symfony/orm-pack" to install and configure Doctrine ORM
      #DATABASE_URL: postgresql://${POSTGRES_USER:-app}:${POSTGRES_PASSWORD:-!ChangeMe!}@database:5432/${POSTGRES_DB:-app}?serverVersion=${POSTGRES_VERSION:-14}&charset=${POSTGRES_CHARSET:-utf8}
      # Run "composer require symfony/mercure-bundle" to install and configure the Mercure integration
      #MERCURE_URL: ${CADDY_MERCURE_URL:-http://caddy/.well-known/mercure}
      #MERCURE_PUBLIC_URL: https://${SERVER_NAME:-localhost}/.well-known/mercure
      #MERCURE_JWT_SECRET: ${CADDY_MERCURE_JWT_SECRET:-!ChangeThisMercureHubJWTSecretKey!}
      APP_ENV: prod

  nginx:
    build:
      context: .
      target: app_nginx
    container_name: antoine.goutenoir.com_nginx
    depends_on:
      - php
    restart: unless-stopped
    #volumes:
      # use a bind-mounted host directory, as we want to keep the media
      #- ./public:/srv/app/public:ro
    # You probably want this ; I handle network weirdly
#    ports:
#      - "80:80"
    environment:
      # Config for server's nginx-reverse-proxy container
      LETSENCRYPT_HOST: antoine.goutenoir.com
      LETSENCRYPT_EMAIL: antoine@goutenoir.com
      VIRTUAL_HOST: antoine.goutenoir.com
      VIRTUAL_PORT: 80
      ###################################################

###> recipes ###
###< recipes ###

# Mercure is installed as a Caddy module, prevent the Flex recipe from installing another service
###> symfony/mercure-bundle ###
###< symfony/mercure-bundle ###

volumes:
  php_socket:
#  caddy_data:
#  caddy_config:
###> symfony/mercure-bundle ###
###< symfony/mercure-bundle ###


# Tip from https://github.com/jwilder/nginx-proxy/issues/1132#issuecomment-392460028
# Create it first: docker network create webproxy
networks:
  default:
    external:
      name: webproxy

